---
title: 'cross-checking: numeric vs choices'
author: "Xinbin Huang"
date: "December 12, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

# Overview
 
## Load libraries

```{r}
library(tidyverse)
library(stringr)
```

## Load data
```{r}
numeric_df <- read_csv('../../TestCase/Canada_Block_TEST_NUMERICValues.csv')
choice_df <- read_csv('../../TestCase/Canada_Block_TEST_ChoiceValues.csv')

numeric_longVar <- numeric_df %>% slice(1:2)
choice_longVar <- choice_df %>% slice(1:2)

numeric_df <- numeric_df %>% slice(3:n())
choice_df <- choice_df %>% slice(3:n())

var_overview <- readxl::read_xlsx('../../QuestionnaireOverviews/VariableOverview_Dec2018.xlsx')
```

## Glimpse

`identical` vs `isTRUE(all_equal())`: `identical` is too strict for most of the cases. When working with `dplyr` verbs, the resulting data frame usually remove the `$spec` attribute (i.e. `attributes(df)`), and this will make identical false when all data entries are the same, (which are the things we care about at most of the time.).

```{r}
check_equal <- function(a, b) {
      return(assertthat::assert_that(all_equal(a, b)))
}

check_identical <- function(a, b){
      return(assertthat::assert_that(isTRUE(all_equal(a, b))))
}

check_sameCols <- function(a, b) {
      cols_a <- colnames(a)
      cols_b <- colnames(b)
      return(check_identical(cols_a, cols_b))
}

# check same columns
check_sameCols(numeric_df, choice_df)
```



```{r}
# Check idential response ID

check_responseID <- function(a, b) {
      ID_a <- a$ResponseId
      ID_b <- b$ResponseId
      return(check_identical(ID_a, ID_b))
}

check_responseID(numeric_df, choice_df)
```


## check each group of variables

get the `var_list`

```{r get var.json}
var_list <- jsonlite::fromJSON('../variables.json', 
                               simplifyVector = FALSE)

labels_list <- var_list %>% 
      map('labels') %>% 
      map(flatten_chr)

names <- var_list %>% 
      map_chr('name')

names(labels_list) <- names
```

define `check_vars` function

```{r}
check_vars <- function(num_df, choice_df, vars) {
      vars_num <- num_df %>% select(vars)
      vars_choice <- choice_df %>% select(vars)
      tryCatch(check_identical(vars_num, vars_choice), 
               error = function(e) {
                     e$message <- paste0(e$message, ". (", 
                                         all.equal(vars_num, vars_choice),
                                         ").")
                     
                     .last.error <<- list(
                           'msg' = e$message,
                           'numeric' = vars_num,
                           'choice' = vars_choice
                     )
                     
                     stop(e)
               })
}
```


1. generic questionaire variables 

Different: `status` and `Finished` columns are different.


```{r generic variables}
gen_vars <- colnames(numeric_df)[1:14]
print(gen_vars)

try(check_vars(numeric_df, choice_df, gen_vars))
.last.error[[2]] %>% slice(363) %>% 
      bind_rows(.last.error[[3]] %>% slice(363))
```


2. `Perceived Descritpive Norms about Childcare`

```{r}
vars <- labels_list$`Perceived Descritpive Norms about Childcare`

check_vars(numeric_df, choice_df, vars = vars)
```


3. `Perceived Descriptive Norms: HEED, STEM and Work`

```{r perceived-descriptive-norms-heed: stem,and work}
vars <- labels_list$`Perceived Descriptive Norms: HEED, STEM and Work`

check_vars(numeric_df, choice_df, vars = vars)
```

4. `Perceived injunctive Norms`

Something problem here need to be checked.

```{r perceived-injunctive-norms}
vars <- labels_list$`Perceived injunctive Norms`

try(check_vars(numeric_df, choice_df, vars = vars))
```

Reason: For `Choice`, some variables, which are encoded as integers from 1 to 7, also include the text for edge values. (i.e. 1, 7)

Solution: extract only the integers.

```{r}
# reason: edge values also include text
.last.error[[2]] %>% slice(362) %>% 
bind_rows(.last.error[[3]] %>% slice(362))
```
```{r}
# solution: extract only numbers
extract_nums <- function(df) {
      extraction <- funs(str_replace(., 
                                     "^([0-9]{1,3}).*",
                                     "\\1"))
      output <- df %>% mutate_all(extraction)
      return(output)
            
}

convert_choiceDF <- function(df, vars) {
      output <- df %>% 
            select(vars) %>% 
            extract_nums()
      return(output)
}


converted_choice <- convert_choiceDF(choice_df, vars)

check_vars(numeric_df, converted_choice, vars = vars)

```

5. `Own Support for Equality`

```{r support-for-equality}
vars <- labels_list$`Own Support for Equality`

try(check_vars(numeric_df, choice_df, vars = vars))

converted_choice <- convert_choiceDF(choice_df, vars)

check_vars(numeric_df, converted_choice, vars = vars)
```

6. `Personal Evaluations`

```{r personal-evaluations}
vars <- labels_list$`Personal Evaluations`

try(check_vars(numeric_df, choice_df, vars = vars))

converted_choice <- convert_choiceDF(choice_df, vars)

check_vars(numeric_df, converted_choice, vars = vars)
```


7. `Family Expectations`

There are some mismatching variables names between the variable list and the original collected data.

`parentleave_motivation` ==> `parentleave_motivati_1`
`parentleave_expectation` ==> `parentleave_expectat`
`expected_share_3` ==> `expected_share_12`

```{r family-expectaction}
vars <- labels_list$`Family Expectations`

mapping <- c('parentleave_motivation' = 'parentleave_motivati_1',
             'parentleave_expectation' = 'parentleave_expectat',
             'expected_share_3' = 'expected_share_12')

map_values <- function(values, mapping) {
      output <- values %>% str_replace_all(mapping) 
      return(output)
}

vars <- map_values(vars, mapping)

try(check_vars(numeric_df, choice_df, vars = vars))
```

The problem cannot be solved entirely by extracting numeric values.

```{r}
converted_choice <- convert_choiceDF(choice_df, vars)
try(check_vars(numeric_df, converted_choice, vars = vars))
```

The column `expect_child` was coded as text only. Need to map it back to numeric scale.

```{r}
mapping <- c('.*already.*' = '1', 
             '.*NOT.*' = '2',
             '.*unsure.*' = '3',
             '.*most likely.*' = '4',
             '.*definitely.*' = '5')

converted_map_choice <- converted_choice %>% 
      mutate(expect_child = map_values(expect_child, mapping))

check_vars(numeric_df, converted_map_choice, vars)
```

8. `Expected Experiences`

- `proximat_domestic_5`, `Intensive_parenting_1`, and `Intensive_parenting_2` do not exist in this data collection.
- also, typo in the original variable list: should be `exp_encouragement_1` instead of `exp_encouragment_1`

```{r expected-experiences}
vars <- labels_list$`Expected Experiences`

remove <- function(vals, remove_vals) {
      return(vals[!vals %in% remove_vals])
}

remove_vals <- c('proximat_domestic_5',
                 'Intensive_parenting_1',
                 'Intensive_parenting_2')

vars <- remove(vars, remove_vals)

try(check_vars(numeric_df, choice_df, vars = vars))

converted_choice <- convert_choiceDF(choice_df, vars)
try(check_vars(numeric_df, converted_choice, vars = vars))
```

9. `Personal Beliefs`

```{r personal-beliefs}
vars <- labels_list$`Personal Beliefs`

try(check_vars(numeric_df, choice_df, vars = vars))

converted_choice <- convert_choiceDF(choice_df, vars)
try(check_vars(numeric_df, converted_choice, vars = vars))
```

10. `Own Parental Background`

```{r parental-background}
vars <- labels_list$`Own Parental Background`

try(check_vars(numeric_df, choice_df, vars = vars))

converted_choice <- convert_choiceDF(choice_df, vars)
try(check_vars(numeric_df, converted_choice, vars = vars))
```

11 `Demographics`

`Immigration_background`, `Not_use`, `uni` do not exist in here.

```{r demographics}
vars <- labels_list$Demographics

remove_vals <- c('Immigration_background',
                 'Not_use',
                 'uni')

vars <- remove(vars, remove_vals)

try(check_vars(numeric_df, choice_df, vars = vars))

converted_choice <- convert_choiceDF(choice_df, vars)
try(check_vars(numeric_df, converted_choice, vars = vars))
```



